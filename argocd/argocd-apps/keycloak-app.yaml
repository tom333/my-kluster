apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: onyxia
    server: https://kubernetes.default.svc
  project: datalab-project
  source:
    repoURL: registry-1.docker.io/bitnamicharts
    chart: keycloak
    targetRevision: 24.7.4
    helm:
      values: |
        auth:
          adminUser: keycloak
          adminPassword: Passw0rd
        production: true
        tls: 
          enabled: false 
          autoGenerated: false
        proxy: edge
        httpRelativePath: "/auth/"
        replicaCount: 1
        ingress:
          enabled: true
          annotations:
            cert-manager.io/cluster-issuer: "letsencrypt-prod"
            nginx.ingress.kubernetes.io/proxy-buffer-size: 128k
          hostname: auth.lab.tgu.ovh
          tls: true
          extraTls:
          - hosts:
            - auth.lab.tgu.ovh
        extraStartupArgs: "--features=preview --log-level=org.keycloak.events:debug"

        extraEnvVars: 
          - name: ONYXIA_RESOURCES_ALLOWED_ORIGINS
            value: "https://datalab.tgu.ovh, http://localhost, http://127.0.0.1"

        initContainers:
          - name: realm-ext-provider
            image: curlimages/curl
            imagePullPolicy: IfNotPresent
            command:
              - sh
            args:
              - -c
              - |
                # NOTE: Here we deploy on Keycloak 24, when updating to Keycloak 26 use this link instead: https://github.com/InseeFrLab/onyxia/releases/download/v10.21.1/keycloak-theme.jar
                # The Onyxia Keycloak theme is published alongside the Onyxia releases as a artifacts: https://github.com/InseeFrLab/onyxia/releases

                curl -L -f -S -o /extensions/theme-onyxia-web.jar https://github.com/InseeFrLab/onyxia/releases/download/v10.21.1/keycloak-theme-for-kc-22-to-25.jar
            volumeMounts:
              - name: extensions
                mountPath: /extensions

        extraVolumeMounts:
          - name: extensions
            mountPath: /opt/bitnami/keycloak/providers

        extraVolumes:
          - name: extensions
            emptyDir: {}
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      selfHeal: true
      prune: true
